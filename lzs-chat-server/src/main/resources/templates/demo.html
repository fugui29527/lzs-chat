<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>client demo</title>
    <script src="http://91vh.com/js/jquery-2.1.4.min.js"></script>
    <script src="js/long.min.js"></script>
    <script src="js/bytebuffer.min.js"></script>
    <script src="js/protobuf.min.js"></script>
</head>
<body>
    <h1>client demo</h1>
    <input id="send_msg" type="text" >
    <input id="sendButton" type="button" value="发送" >
    <div style="height: 400px;width: 400px; background: bisque">
        <p>聊天内容:</p>
        <div id="content">

        </div>
    </div>

    <script>
        var ProtoBuf = dcodeIO.ProtoBuf;
        //var AuthReq = ProtoBuf.loadProtoFile("../pb/auth.proto").build("AuthReq");
        var Request = ProtoBuf.loadProtoFile("../pb/message.proto").build("Request");
        var Response = ProtoBuf.loadProtoFile("../pb/message.proto").build("Response");
        const rawHeaderLen = 16;
        const packetOffset = 0, headerOffset = 4, verOffset = 6, opOffset = 8, seqOffset = 12;
        const opAuth = 1, opAuthReply=2, opHeartbeat=3, opHeartbeatReply=4, opMessage=5, opMessageReply=6;
        var heartbeatInterval;
        var ws
        function connect() {
            ws = new WebSocket('ws://127.0.0.1:9001/chat');
            ws.binaryType = 'arraybuffer';
            ws.onopen = function() {
                auth();
            }

            ws.onmessage = function(evt) {
                console.log("===收到消息===")
                var data = evt.data;

                var resp =Response.decode(data)
                console.log(resp)
                var op =resp.operation;
                // var dataView = new DataView(data, 0);
                // var packetLen = dataView.getInt32(packetOffset);
                // var headerLen = dataView.getInt16(headerOffset);
                // var ver = dataView.getInt16(verOffset);
                // var op = dataView.getInt32(opOffset);
                // var seq = dataView.getInt32(seqOffset);
                //console.log("packetLen=" + packetLen, "headerLen=" + headerLen, "ver=" + ver, "op=" + op, "seq=" + seq);

                switch(op) {
                    case opAuthReply:
                        // 授权成功
                        if(resp.code == 1){
                            console.log("授权成功=====");

                        }else {
                            console.log("授权失败=====");

                        }
                        //heartbeat();
                        //heartbeatInterval = setInterval(heartbeat, 30 * 1000);
                    break;
                    case opHeartbeatReply:
                        // 心跳
                        console.log("heartbeat ok");
                    break;
                    case opMessageReply:
                        // 消息
                        if(resp.code == 1){
                            $("#content").append($("#send_msg").val())
                            $("#send_msg").val("")
                        }
                    break;
                }
            }

            ws.onclose = function() {
                // if (heartbeatInterval) clearInterval(heartbeatInterval);
                // // 重连 3s~5s
                // var delay = Math.floor(Math.random() * (6 - 3) + 3);
                // setTimeout(connect, delay * 1000);
                // console.log(delay);
            }

            function heartbeat() {
                var headerBuf = new ArrayBuffer(rawHeaderLen);
                var headerView = new DataView(headerBuf, 0);
                headerView.setInt32(packetOffset, rawHeaderLen);
                headerView.setInt16(headerOffset, rawHeaderLen);
                headerView.setInt16(verOffset, 1);
                headerView.setInt32(opOffset, opHeartbeat);
                headerView.setInt32(seqOffset, 1);
                ws.send(headerBuf);
            }

            function auth() {
                //var authReq = new AuthReq();
                var req =new Request()
                req.appkey = "1233";
                req.operation = 1;
                req.version = 1;
                var jsonObj = "{\"userId\":\"112233\",\"roomId\":54321}";
                req.data=jsonObj;
                // var headerBuf = new ArrayBuffer(rawHeaderLen);
                // var headerView = new DataView(headerBuf, 0);
                // var bodyBuf = authReq.toArrayBuffer()
                // headerView.setInt32(packetOffset, rawHeaderLen + bodyBuf.byteLength);
                // headerView.setInt16(headerOffset, rawHeaderLen);
                // headerView.setInt16(verOffset, 1);
                // headerView.setInt32(opOffset, opAuth);
                // headerView.setInt32(seqOffset, 1);

                //ws.send(mergeArrayBuffer(headerBuf, bodyBuf));
                ws.send(req.toArrayBuffer());
            }

            function recevice(body) {
                console.log(body);
            }
            
        }

        function sendMsg() {
            var msg =$("#send_msg").val();
            var req =new Request()
            req.appkey = "1233";
            req.operation = 5;
            req.version = 1;
            req.token="abcd1234"
            req.data="{'userId:'112233','roomId':54321,msg="+msg+"}"
            ws.send(req.toArrayBuffer());
        }
        connect();

        $(function(){
            $("#sendButton").click(function () {
                sendMsg();
            });
        });
    </script>
</body>
</html>